#!/bin/sh

# ~/.config/river/init
# This script is run once river’s Wayland server is up, before entering the main loop.

# ─── A) Keyboard layout and environment variables ─────────────────────────────────
riverctl keyboard-layout \
  -variant mac \
  -options "ctrl:nocaps" \
  us

export GTK_THEME=Arc-Dark
export QT_STYLE_OVERRIDE=adwaita
export QT_QPA_PLATFORMTHEME=qt5ct

# ─── B) Output configuration (wlr-randr instead of xrandr) ───────────────────────
if wlr-randr | grep -q '^DP-'; then
  # At least one DP-connected monitor exists
  wlr-randr \
    --output DP-11 --mode 1920x1080 --pos 0,0 --transform 90 \
    --output DP-13 --mode 1920x1080 --pos 1080,0 --transform normal \
    --output eDP-1 --mode 2256x1504 --pos 1080,1080 --transform normal --scale 2.0
else
  # No DP output detected
  echo "only laptop panel"
fi

# ─── C) Screen-lock / idle handling ───────────────────────────────────────────────
swayidle \
  timeout 1200 'swaylock -f' \
  resume 'swaymsg "seat0 disable_idle"' \
  before-sleep 'swaylock -f' &

# ─── D) Cursor theme and XKB remapping ────────────────────────────────────────────
riverctl xcursor-theme left_ptr 24
# (Caps → Control happens via XKB settings under Wayland/Xwayland)

# ─── E) Autostart daemons and utilities ──────────────────────────────────────────
dunst &

pkill -9 polkit-gnome-authentication-agent-1 2>/dev/null
/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &

wlsunset &
waybar &
rivertile &

# ─── F) Border and background colors ─────────────────────────────────────────────
riverctl border-color-focused   0x9933cc   # purple
riverctl border-color-unfocused 0x8b877c   # taupe
riverctl border-color-urgent    0x1ac6ca   # calmcyan
riverctl background-color       0x02091C   # deepnight background

# ─── G) Floating rules for specific apps ─────────────────────────────────────────
riverctl rule-add -app-id 'Yad'          float
riverctl rule-add -app-id 'Galculator'   float
riverctl rule-add -app-id 'Blueberry.py' float
riverctl rule-add -app-id 'Xsane'        float
riverctl rule-add -app-id 'Pavucontrol'  float
riverctl rule-add -app-id 'qt5ct'        float
riverctl rule-add -app-id 'Bluetooth-sendto' float
riverctl rule-add -app-id 'Pamac-manager'   float
riverctl rule-add -window-role 'About'      float

# ─── H) Declare custom modes ─────────────────────────────────────────────────────
riverctl declare-mode resize

# ─── I) Keybindings: Workspaces (tags) and navigation ────────────────────────────
# Focus tags 1..9
riverctl map normal Super   1 set-focused-tags 1     # 0b000000001
riverctl map normal Super   2 set-focused-tags 2     # 0b000000010
riverctl map normal Super   3 set-focused-tags 4     # 0b000000100
riverctl map normal Super   4 set-focused-tags 8     # 0b000001000
riverctl map normal Super   5 set-focused-tags 16    # 0b000010000
riverctl map normal Super   6 set-focused-tags 32    # 0b000100000
riverctl map normal Super   7 set-focused-tags 64    # 0b001000000
riverctl map normal Super   8 set-focused-tags 128   # 0b010000000
riverctl map normal Super   9 set-focused-tags 256   # 0b100000000
riverctl map normal Super   0 set-focused-tags 512   # 0b100000000

# Move focused view into a different tag
riverctl map normal Super+Shift 1 set-view-tags 1
riverctl map normal Super+Shift 2 set-view-tags 2
riverctl map normal Super+Shift 3 set-view-tags 4
riverctl map normal Super+Shift 4 set-view-tags 8
riverctl map normal Super+Shift 5 set-view-tags 16
riverctl map normal Super+Shift 6 set-view-tags 32
riverctl map normal Super+Shift 7 set-view-tags 64
riverctl map normal Super+Shift 8 set-view-tags 128
riverctl map normal Super+Shift 9 set-view-tags 256
riverctl map normal Super+Shift 0 set-view-tags 512

# Cycle tags (“Next” / “Previous” workspace)
riverctl map normal Super Tab           focus-previous-tags
riverctl map normal Super+Shift Tab    focus-previous-tags
riverctl map normal Super+Shift O      focus-previous-tags

# Close, spawn terminal, and fullscreen
riverctl map normal Super Q             close
riverctl map normal Super Return        spawn kitty
riverctl map normal Super+Shift F       toggle-fullscreen

# Focus outputs directionally
riverctl map normal Super+Alt H         focus-output left
riverctl map normal Super+Alt L         focus-output right
riverctl map normal Super+Alt J         focus-output down
riverctl map normal Super+Alt K         focus-output up

riverctl map normal Super+Shift N         send-to-output next
riverctl map normal Super+Shift P         focus-output previous

riverctl map normal Super+Alt J         focus-output down
riverctl map normal Super+Alt K         focus-output up

# Focus views within current workspace
riverctl map normal Super J             focus-view next
riverctl map normal Super K             focus-view previous

# Swap views
riverctl map normal Super+Shift J       swap next
riverctl map normal Super+Shift K       swap previous

# Zoom focused view
riverctl map normal Super+Shift Return  zoom

# Rivertile layout adjustments
riverctl map normal Super H             send-layout-cmd rivertile "main-ratio -0.05"
riverctl map normal Super L             send-layout-cmd rivertile "main-ratio +0.05"
riverctl map normal Alt+Shift H         send-layout-cmd rivertile "main-count +1"
riverctl map normal Alt+Shift L         send-layout-cmd rivertile "main-count -1"


riverctl map normal Super U send-layout-cmd rivertile "main-location left"
riverctl map normal Super I send-layout-cmd rivertile "main-location bottom"
riverctl map normal Super O send-layout-cmd rivertile "main-location top"
riverctl map normal Super P send-layout-cmd rivertile "main-location right"

riverctl default-layout rivertile

# Enter/exit resize mode (like i3’s resize mode)
riverctl map normal Super r             enter-mode resize
riverctl map resize None Left           resize horizontal -10
riverctl map resize None Right          resize horizontal +10
riverctl map resize None Up             resize vertical   -10
riverctl map resize None Down           resize vertical   +10
riverctl map resize None Return         enter-mode normal
riverctl map resize None Escape         enter-mode normal

# Previous window focus (i3-back equivalent)
riverctl map normal Super+Shift Backspace focus-view previous

# Reload, restart, exit river
riverctl map normal Super+Shift C       reload
riverctl map normal Super+Shift R       restart
riverctl map normal Super+Shift E       exit

# Spawn application launcher and window switcher
riverctl map normal Super D             spawn 'wofi --show drun'
riverctl map normal Super+Shift D       spawn 'wofi --show window'

# Ctrl+Alt+Delete → exit to TTY
riverctl map normal Control+Alt Delete  exit

# ─── J) Keyboard repeat settings ─────────────────────────────────────────────────
riverctl set-repeat 50 300

# ─── K) Volume, brightness, and media keys (for both normal and locked modes) ────
for mode in normal locked; do
  # Volume up/down
  riverctl map "$mode" None Prior               spawn '~/.config/river/scripts/volume_up.sh'
  riverctl map "$mode" None Next                spawn '~/.config/river/scripts/volume_down.sh'
  riverctl map "$mode" None XF86AudioRaiseVolume spawn '~/.config/river/scripts/volume_up.sh'
  riverctl map "$mode" None XF86AudioLowerVolume spawn '~/.config/river/scripts/volume_down.sh'
  riverctl map "$mode" None XF86AudioMute         spawn '~/.config/river/scripts/toggle_mute.sh'

  # Brightness up/down
  riverctl map "$mode" None XF86MonBrightnessUp   spawn '~/.config/river/scripts/brightness_up.sh'
  riverctl map "$mode" None XF86MonBrightnessDown spawn '~/.config/river/scripts/brightness_down.sh'

  # Media controls
  riverctl map "$mode" None XF86AudioPlay         spawn '~/.config/river/scripts/media_play_pause.sh'
  riverctl map "$mode" None XF86AudioNext         spawn '~/.config/river/scripts/media_next.sh'
  riverctl map "$mode" None XF86AudioPrev         spawn '~/.config/river/scripts/media_prev.sh'
done

# ─── End of active configuration ─────────────────────────────────────────────────

# ──────────────────────────────────────────────────────────────────────────────
# Stand-alone commentary and addendum (for reference only; not executed)
# ──────────────────────────────────────────────────────────────────────────────

# • Use this script to configure outputs, keybindings, and autostarts under Wayland/river.
# • Remove any “sudo systemctl enable …” lines; enable them manually:
#     sudo systemctl enable --now geoclue.service
#     sudo systemctl enable --now seatd
#
# A) Rebuild font cache and run XDG autostart (replacement for i3’s fc-cache and dex):
#    fc-cache -r &
#    dex --autostart --environment river &
#
# B) X11-based helpers (picom, xinput, xss-lock):
#    - picom: no direct equivalent under Wayland; drop entirely.
#    - xinput tweaks: use libinput or input-remapper; most defaults are fine.
#    - xss-lock + i3lock: replaced by swayidle + swaylock (already in section C).
#
# C) Network tray, Bluetooth tray, and redshift:
#    Under i3:
#      exec --no-startup-id nm-applet
#      exec --no-startup-id blueman-applet
#      exec --no-startup-id redshift-gtk -l geoclue2 -t 6500:2000
#    Under river:
#      nm-applet &        # Xwayland tray icons in Waybar’s tray
#      blueman-applet &   # Xwayland tray icons
#      wlsunset -l 40.44:-79.99 -t 6500:2000 &   # replaces redshift-gtk
#
# D) “i3-back” daemon (workspace back/forward):
#    i3 config used a focus-change listener. Under river, “focus-previous-tags” covers history.
#    If a custom back binding is needed, use Super+Shift+O (already bound above).
#
# E) Generative background script:
#    i3 ran:
#      exec --no-startup-id ~/.config/i3/generative_background.bash
#    Under Wayland:
#      - Convert script to generate a PNG and run swaybg:
#          swaybg -i ~/.config/river/solid_color.png -m stretch &
#      - Or spawn the existing script under Xwayland:
#          ~/.config/i3/generative_background.bash &
#
# F) Polkit agent:
#    i3: exec --no-startup-id /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
#    Under river: same, but kill any existing instance first (in section E).
#
# G) Audio and brightness keys (pamixer / volume_brightness.sh):
#    i3 bound XF86AudioRaiseVolume and XF86MonBrightnessUp to custom scripts.
#    Under river: ported to riverctl “spawn” in section K.
#
# H) Workspace naming and “auto back and forth”:
#    i3 had “workspace_auto_back_and_forth yes” and numeric workspace aliases.
#    Under river: “focus-previous-tags” handles back-and-forth. Numeric shortcuts are explicit tags above.
#
# I) Floating rules for specific apps:
#    i3 used “for_window [class=…] floating enable”. Under river: `riverctl rule-add`.
#
# J) Color definitions:
#    i3 set a palette for client.focused, etc. Under river: colors are global (set once in section F).
#
# K) “resize” mode (i3’s mode “resize”):
#    Declared and mapped in section H.
#
# L) “i3-back” equivalent for “previous window”:
#    Mapped Super+Shift+Backspace in section H.
#
# M) “reload” and “restart”:
#    Mapped Super+Shift+C and Super+Shift+R in section H.
#
# N) If you also want a “logout” via keybinding rather than wlogout:
#    Super+Shift+E is mapped to exit in section H (and wlogout is spawned for graphical logout).
#
# O) Final reminders:
# 1) Ensure all custom scripts are executable (`chmod +x ...`) and work under Wayland.
# 2) Run “riverctl reload” or restart river after saving this file to apply changes.
# 3) Double-check that geoclue.service and seatd are enabled manually as needed.
# 4) Remove any leftover i3-specific lines once fully migrated.
# ──────────────────────────────────────────────────────────────────────────────
